<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åˆ‡æ¢ä¸»é¢˜</title>
  <script src="../src/theme-manager.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg: #020810;
      --bg-card: rgba(0, 30, 55, 0.6);
      --border: rgba(0, 255, 240, 0.3);
      --border-bright: rgba(0, 255, 240, 0.7);
      --neon-cyan: #00fff0;
      --neon-magenta: #ff2d78;
      --text: #cff0ff;
      --text-muted: rgba(160, 220, 240, 0.55);
      --glow-sm: 0 0 8px rgba(0, 255, 240, 0.4);
      --radius: 8px;
      --header-bg: rgba(0, 15, 30, 0.98);
      --close-icon: rgba(160, 220, 240, 0.6);
      --danger-glow: 0 0 8px rgba(255, 45, 120, 0.4);
      --scrollbar: rgba(0, 255, 240, 0.35);
      --scrollbar-hover: rgba(0, 255, 240, 0.6);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .window-header {
      background: var(--header-bg);
      padding: 12px 16px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--border);
      -webkit-app-region: drag;
      flex-shrink: 0;
    }

    .window-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--neon-cyan);
      letter-spacing: 0.5px;
      text-shadow: var(--glow-sm);
    }

    .close-btn {
      background: transparent;
      border: 1px solid var(--border);
      width: 26px;
      height: 26px;
      border-radius: 6px;
      cursor: pointer;
      -webkit-app-region: no-drag;
      transition: border-color 0.2s, box-shadow 0.2s;
      position: relative;
      flex-shrink: 0;
    }

    .close-btn::before,
    .close-btn::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 11px;
      height: 1.5px;
      background: var(--close-icon);
      border-radius: 2px;
      transform-origin: center;
      transition: background 0.2s;
    }

    .close-btn::before { transform: translate(-50%, -50%) rotate(45deg); }
    .close-btn::after  { transform: translate(-50%, -50%) rotate(-45deg); }

    .close-btn:hover {
      border-color: var(--neon-magenta);
      box-shadow: var(--danger-glow);
    }

    .close-btn:hover::before,
    .close-btn:hover::after {
      background: var(--neon-magenta);
    }

    .content {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .section-title {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 1px;
      text-transform: uppercase;
      color: var(--text-muted);
    }

    .theme-cards {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .theme-card {
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      cursor: pointer;
      transition: border-color 0.2s, box-shadow 0.2s, transform 0.15s;
      position: relative;
    }

    .theme-card:hover {
      border-color: var(--border-bright);
      box-shadow: var(--glow-sm);
      transform: translateY(-1px);
    }

    .theme-card.active {
      border-color: var(--neon-cyan);
      box-shadow: var(--glow-sm);
    }

    .theme-card.active .active-badge {
      display: flex;
    }

    .active-badge {
      display: none;
      position: absolute;
      top: 10px;
      right: 10px;
      align-items: center;
      gap: 3px;
      font-size: 10px;
      font-weight: 700;
      color: var(--neon-cyan);
      letter-spacing: 0.3px;
      text-shadow: var(--glow-sm);
    }

    /* èµ›åšæœ‹å…‹é¢„è§ˆ */
    .theme-preview {
      height: 68px;
      padding: 10px 14px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .preview-cyberpunk {
      background: linear-gradient(135deg, #020810 0%, #001833 100%);
    }

    .preview-lazyCat {
      background: linear-gradient(135deg, #1a0e05 0%, #2e1808 100%);
    }

    .preview-bar {
      display: flex;
      gap: 5px;
      align-items: center;
    }

    .preview-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .preview-line {
      height: 2px;
      flex: 1;
      border-radius: 2px;
    }

    /* èµ›åšæœ‹å…‹é¢„è§ˆè‰² */
    .preview-cyberpunk .preview-dot { background: #00fff0; box-shadow: 0 0 5px #00fff0; }
    .preview-cyberpunk .preview-line { background: rgba(0, 255, 240, 0.25); }
    .preview-cyberpunk .preview-text { font-size: 11px; font-weight: 700; color: #00fff0; text-shadow: 0 0 8px #00fff0; }
    .preview-cyberpunk .preview-sub  { font-size: 9px; color: rgba(160, 220, 240, 0.55); }

    /* æ‡’çŒ«æ©˜é¢„è§ˆè‰² */
    .preview-lazyCat .preview-dot { background: #ffb347; box-shadow: 0 0 5px #ffb347; }
    .preview-lazyCat .preview-line { background: rgba(255, 175, 70, 0.25); }
    .preview-lazyCat .preview-text { font-size: 11px; font-weight: 700; color: #ffb347; text-shadow: 0 0 8px rgba(255, 180, 70, 0.6); }
    .preview-lazyCat .preview-sub  { font-size: 9px; color: rgba(255, 205, 155, 0.55); }

    .theme-info {
      padding: 10px 14px;
      background: var(--bg-card);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .theme-icon { font-size: 22px; line-height: 1; }

    .theme-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 2px;
    }

    .theme-desc {
      font-size: 11px;
      color: var(--text-muted);
    }

    ::-webkit-scrollbar { width: 3px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--scrollbar); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-hover); }

    /* åŠ è½½çŠ¶æ€æ ·å¼ */
    .loading-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      gap: 16px;
    }

    .loading-spinner {
      width: 32px;
      height: 32px;
      border: 3px solid var(--border);
      border-top-color: var(--neon-cyan);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      font-size: 13px;
      color: var(--text-muted);
      animation: pulse 1.5s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }

    /* é”™è¯¯æç¤ºæ ·å¼ */
    .error-toast {
      animation: slideDown 0.3s ease-out, neonPulse 1.5s ease-in-out infinite;
    }

    .theme-card {
      user-select: none;
      -webkit-user-select: none;
    }

    .theme-card:active {
      transform: scale(0.98);
    }
  </style>
</head>
<body>
  <div class="window-header">
    <div class="window-title">ğŸ¨ åˆ‡æ¢ä¸»é¢˜</div>
    <button class="close-btn" data-action="close"></button>
  </div>

  <div class="content">
    <div class="section-title">é€‰æ‹©ä¸»é¢˜é£æ ¼</div>
    <div class="theme-cards">

      <!-- èµ›åšæœ‹å…‹ -->
      <div class="theme-card" id="card-cyberpunk" data-theme="cyberpunk">
        <span class="active-badge">âœ“ å½“å‰ä¸»é¢˜</span>
        <div class="theme-preview preview-cyberpunk">
          <div class="preview-bar">
            <div class="preview-dot"></div>
            <div class="preview-line"></div>
            <div class="preview-dot" style="background:#ff2d78;box-shadow:0 0 5px #ff2d78"></div>
          </div>
          <div>
            <div class="preview-text">âš¡ CYBER PUNK</div>
            <div class="preview-sub">éœ“è™¹ Â· æ·±å¤œ Â· éƒ½å¸‚</div>
          </div>
        </div>
        <div class="theme-info">
          <div class="theme-icon">âš¡</div>
          <div>
            <div class="theme-name">èµ›åšæœ‹å…‹</div>
            <div class="theme-desc">éœ“è™¹é’ + å“çº¢ï¼Œæ·±å¤œéƒ½å¸‚é£</div>
          </div>
        </div>
      </div>

      <!-- æ‡’çŒ«æ©˜ -->
      <div class="theme-card" id="card-lazyCat" data-theme="lazyCat">
        <span class="active-badge">âœ“ å½“å‰ä¸»é¢˜</span>
        <div class="theme-preview preview-lazyCat">
          <div class="preview-bar">
            <div class="preview-dot"></div>
            <div class="preview-line"></div>
            <div class="preview-dot" style="background:#ff6b35;box-shadow:0 0 5px #ff6b35"></div>
          </div>
          <div>
            <div class="preview-text">ğŸ± æ‡’çŒ«æ©˜</div>
            <div class="preview-sub">æ¸©æš– Â· æ©˜é»„ Â· æ…µæ‡’åˆå</div>
          </div>
        </div>
        <div class="theme-info">
          <div class="theme-icon">ğŸ±</div>
          <div>
            <div class="theme-name">æ‡’çŒ«æ©˜</div>
            <div class="theme-desc">æš–æ©˜ + æ©™çº¢ï¼Œä¸å® ç‰©ç›¸é…</div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // ä¸»é¢˜çª—å£æ§åˆ¶å™¨
    (function() {
      'use strict';

      console.log('[ThemeWindow] åˆå§‹åŒ–å¼€å§‹');

      // çŠ¶æ€ç®¡ç†
      const state = {
        isInitialized: false,
        isLoading: false,
        currentTheme: null,
        retryCount: 0,
        maxRetries: 3
      };

      // DOM å…ƒç´ å¼•ç”¨
      const elements = {
        themeCards: null,
        loadingState: null,
        errorContainer: null
      };

      // æ›´æ–°å½“å‰æ¿€æ´»çš„ä¸»é¢˜å¡ç‰‡
      function updateActiveCard() {
        console.log('[ThemeWindow] updateActiveCard è°ƒç”¨');

        // æ£€æŸ¥ ThemeManager å¯ç”¨æ€§
        if (!window.ThemeManager) {
          console.error('[ThemeWindow] ThemeManager æœªå®šä¹‰ï¼');
          showError('ä¸»é¢˜ç®¡ç†å™¨æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
          return false;
        }

        try {
          const current = window.ThemeManager.getCurrent();
          console.log('[ThemeWindow] å½“å‰ä¸»é¢˜:', current);
          state.currentTheme = current;

          // ç§»é™¤æ‰€æœ‰æ¿€æ´»çŠ¶æ€
          if (elements.themeCards) {
            elements.themeCards.forEach(card => card.classList.remove('active'));

            // æ¿€æ´»å½“å‰ä¸»é¢˜
            const activeCard = document.getElementById('card-' + current);
            if (activeCard) {
              activeCard.classList.add('active');
              console.log('[ThemeWindow] å·²æ¿€æ´»ä¸»é¢˜å¡ç‰‡:', current);
              return true;
            } else {
              console.warn('[ThemeWindow] æœªæ‰¾åˆ°ä¸»é¢˜å¡ç‰‡:', current);
            }
          }
        } catch (error) {
          console.error('[ThemeWindow] æ›´æ–°æ¿€æ´»å¡ç‰‡å¤±è´¥:', error);
          showError('æ›´æ–°ä¸»é¢˜çŠ¶æ€å¤±è´¥: ' + error.message);
        }
        return false;
      }

      // é€‰æ‹©ä¸»é¢˜
      function selectTheme(name) {
        console.log('[ThemeWindow] selectTheme è°ƒç”¨ï¼Œä¸»é¢˜:', name);

        // æ£€æŸ¥ ThemeManager å¯ç”¨æ€§
        if (!window.ThemeManager) {
          console.error('[ThemeWindow] ThemeManager æœªå®šä¹‰ï¼');
          showError('ä¸»é¢˜ç®¡ç†å™¨æœªåŠ è½½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
          return;
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        showLoading(true);

        try {
          window.ThemeManager.save(name);
          console.log('[ThemeWindow] ä¸»é¢˜å·²ä¿å­˜:', name);
          updateActiveCard();
          showSuccess('ä¸»é¢˜å·²åˆ‡æ¢');
        } catch (error) {
          console.error('[ThemeWindow] ä¿å­˜ä¸»é¢˜å¤±è´¥:', error);
          showError('åˆ‡æ¢ä¸»é¢˜å¤±è´¥: ' + error.message);
        } finally {
          // å»¶è¿Ÿéšè—åŠ è½½çŠ¶æ€
          setTimeout(() => showLoading(false), 300);
        }
      }

      // å…³é—­çª—å£
      function closeWindow() {
        console.log('[ThemeWindow] closeWindow è°ƒç”¨');

        // æ£€æŸ¥ electron API å¯ç”¨æ€§
        if (!window.electron) {
          console.error('[ThemeWindow] window.electron æœªå®šä¹‰ï¼');
          showError('æ— æ³•å…³é—­çª—å£ï¼šAPI ä¸å¯ç”¨');
          return;
        }

        if (!window.electron.closeChildWindow) {
          console.error('[ThemeWindow] window.electron.closeChildWindow æœªå®šä¹‰ï¼');
          showError('æ— æ³•å…³é—­çª—å£ï¼šæ–¹æ³•ä¸å¯ç”¨');
          return;
        }

        try {
          window.electron.closeChildWindow('theme');
        } catch (error) {
          console.error('[ThemeWindow] å…³é—­çª—å£å¤±è´¥:', error);
          showError('å…³é—­çª—å£å¤±è´¥: ' + error.message);
        }
      }

      // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
      function showLoading(show) {
        state.isLoading = show;
        if (elements.loadingState) {
          elements.loadingState.style.display = show ? 'flex' : 'none';
        }
      }

      // æ˜¾ç¤ºé”™è¯¯æç¤º
      function showError(message) {
        removeErrorToast();

        const toast = document.createElement('div');
        toast.className = 'error-toast';
        toast.textContent = message;
        toast.style.cssText = `
          position: fixed;
          top: 20px;
          left: 50%;
          transform: translateX(-50%);
          background: var(--neon-magenta);
          color: white;
          padding: 12px 24px;
          border-radius: var(--radius);
          box-shadow: var(--danger-glow);
          z-index: 1000;
          font-size: 13px;
          animation: slideDown 0.3s ease-out, neonPulse 1.5s ease-in-out infinite;
        `;

        if (elements.errorContainer) {
          elements.errorContainer.appendChild(toast);
        } else {
          document.body.appendChild(toast);
        }

        // 3 ç§’åè‡ªåŠ¨ç§»é™¤
        setTimeout(() => {
          if (toast.parentNode) {
            toast.remove();
          }
        }, 3000);
      }

      // æ˜¾ç¤ºæˆåŠŸæç¤º
      function showSuccess(message) {
        removeErrorToast();

        const toast = document.createElement('div');
        toast.className = 'success-toast';
        toast.textContent = message;
        toast.style.cssText = `
          position: fixed;
          top: 20px;
          left: 50%;
          transform: translateX(-50%);
          background: var(--neon-cyan);
          color: #020810;
          padding: 12px 24px;
          border-radius: var(--radius);
          box-shadow: var(--glow-sm);
          z-index: 1000;
          font-size: 13px;
          font-weight: 600;
          animation: slideDown 0.3s ease-out;
        `;

        if (elements.errorContainer) {
          elements.errorContainer.appendChild(toast);
        } else {
          document.body.appendChild(toast);
        }

        setTimeout(() => {
          if (toast.parentNode) {
            toast.remove();
          }
        }, 2000);
      }

      // ç§»é™¤é”™è¯¯æç¤º
      function removeErrorToast() {
        const existing = document.querySelector('.error-toast');
        if (existing) existing.remove();

        const success = document.querySelector('.success-toast');
        if (success) success.remove();
      }

      // äº‹ä»¶å§”æ‰˜å¤„ç†
      function setupEventDelegation() {
        console.log('[ThemeWindow] è®¾ç½®äº‹ä»¶å§”æ‰˜');

        // ä¸»é¢˜å¡ç‰‡ç‚¹å‡»äº‹ä»¶
        const themeCardsContainer = document.querySelector('.theme-cards');
        if (themeCardsContainer) {
          themeCardsContainer.addEventListener('click', function(e) {
            const card = e.target.closest('.theme-card');
            if (card && card.dataset.theme) {
              console.log('[ThemeWindow] ä¸»é¢˜å¡ç‰‡è¢«ç‚¹å‡»:', card.dataset.theme);
              selectTheme(card.dataset.theme);
            }
          });
          console.log('[ThemeWindow] ä¸»é¢˜å¡ç‰‡äº‹ä»¶å§”æ‰˜å·²ç»‘å®š');
        } else {
          console.error('[ThemeWindow] æœªæ‰¾åˆ° .theme-cards å®¹å™¨');
        }

        // å…³é—­æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        const closeBtn = document.querySelector('.close-btn');
        if (closeBtn) {
          closeBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            closeWindow();
          });
          console.log('[ThemeWindow] å…³é—­æŒ‰é’®äº‹ä»¶å·²ç»‘å®š');
        } else {
          console.error('[ThemeWindow] æœªæ‰¾åˆ° .close-btn æŒ‰é’®');
        }
      }

      // ç­‰å¾… ThemeManager åŠ è½½
      function waitForThemeManager() {
        return new Promise((resolve, reject) => {
          if (window.ThemeManager) {
            resolve();
            return;
          }

          let attempts = 0;
          const maxAttempts = 10;
          const interval = 50;

          const checkInterval = setInterval(() => {
            attempts++;
            console.log(`[ThemeWindow] ç­‰å¾… ThemeManager... (${attempts}/${maxAttempts})`);

            if (window.ThemeManager) {
              clearInterval(checkInterval);
              resolve();
            } else if (attempts >= maxAttempts) {
              clearInterval(checkInterval);
              reject(new Error('ThemeManager åŠ è½½è¶…æ—¶'));
            }
          }, interval);
        });
      }

      // åˆå§‹åŒ–åº”ç”¨
      async function initialize() {
        if (state.isInitialized) {
          console.log('[ThemeWindow] å·²ç»åˆå§‹åŒ–ï¼Œè·³è¿‡');
          return;
        }

        console.log('[ThemeWindow] å¼€å§‹åˆå§‹åŒ–');

        // è·å– DOM å…ƒç´ 
        elements.themeCards = document.querySelectorAll('.theme-card');
        elements.loadingState = document.getElementById('loading-state');
        elements.errorContainer = document.getElementById('error-container');

        console.log('[ThemeWindow] ThemeManager å¯ç”¨:', !!window.ThemeManager);
        console.log('[ThemeWindow] electron API å¯ç”¨:', !!window.electron);

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        showLoading(true);

        try {
          // ç­‰å¾… ThemeManager åŠ è½½
          await waitForThemeManager();
          console.log('[ThemeWindow] ThemeManager å·²å°±ç»ª');

          // è®¾ç½®äº‹ä»¶å§”æ‰˜
          setupEventDelegation();

          // æ›´æ–°å½“å‰æ¿€æ´»çš„ä¸»é¢˜
          updateActiveCard();

          state.isInitialized = true;
          console.log('[ThemeWindow] åˆå§‹åŒ–å®Œæˆ');
        } catch (error) {
          console.error('[ThemeWindow] åˆå§‹åŒ–å¤±è´¥:', error);
          showError('ä¸»é¢˜ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        } finally {
          // éšè—åŠ è½½çŠ¶æ€
          setTimeout(() => showLoading(false), 200);
        }
      }

      // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initialize);
      } else {
        // DOM å·²ç»åŠ è½½å®Œæˆï¼Œç›´æ¥åˆå§‹åŒ–
        initialize();
      }

      // æš´éœ² API åˆ°å…¨å±€ï¼ˆç”¨äºè°ƒè¯•ï¼‰
      window.ThemeWindowAPI = {
        selectTheme: selectTheme,
        closeWindow: closeWindow,
        updateActiveCard: updateActiveCard,
        getState: () => ({ ...state })
      };

      console.log('[ThemeWindow] è„šæœ¬åŠ è½½å®Œæˆ');
    })();
  </script>
</body>
</html>
