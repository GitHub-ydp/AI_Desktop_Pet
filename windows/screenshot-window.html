<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æˆªå›¾é¢„è§ˆ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f5f5;
      overflow: hidden;
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    /* é¡¶éƒ¨æ ‡é¢˜æ  */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      background: #fff;
      border-bottom: 1px solid #e0e0e0;
      -webkit-app-region: drag;
    }

    .header h1 {
      font-size: 16px;
      font-weight: 500;
      color: #333;
    }

    .close-btn {
      -webkit-app-region: no-drag;
      width: 32px;
      height: 32px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 20px;
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: background 0.2s;
    }

    .close-btn:hover {
      background: #f0f0f0;
    }

    /* é¢„è§ˆåŒºåŸŸ */
    .preview {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      overflow: auto;
    }

    .preview img {
      max-width: 100%;
      max-height: 100%;
      object-fit: contain;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      border-radius: 4px;
    }

    /* å·¥å…·æ  */
    .toolbar {
      display: flex;
      gap: 8px;
      padding: 12px 16px;
      background: #fff;
      border-top: 1px solid #e0e0e0;
      flex-wrap: wrap;
    }

    .toolbar-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      border: 1px solid #ddd;
      background: #fff;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      color: #333;
      transition: all 0.2s;
    }

    .toolbar-btn:hover {
      background: #f5f5f5;
      border-color: #999;
    }

    .toolbar-btn:active {
      background: #e8e8e8;
    }

    .toolbar-btn.primary {
      background: #3b82f6;
      color: #fff;
      border-color: #3b82f6;
    }

    .toolbar-btn.primary:hover {
      background: #2563eb;
      border-color: #2563eb;
    }

    .toolbar-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* åˆ†æç»“æœåŒºåŸŸ */
    .analysis-result {
      display: none;
      padding: 16px;
      background: #f9f9f9;
      border-top: 1px solid #e0e0e0;
      max-height: 200px;
      overflow-y: auto;
    }

    .analysis-result.show {
      display: block;
    }

    .analysis-result h3 {
      font-size: 14px;
      font-weight: 500;
      color: #333;
      margin-bottom: 8px;
    }

    .analysis-result pre {
      background: #fff;
      padding: 12px;
      border-radius: 4px;
      font-size: 13px;
      line-height: 1.5;
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    /* é€šçŸ¥æç¤º */
    .notification {
      position: fixed;
      top: 60px;
      right: 20px;
      padding: 12px 20px;
      background: #333;
      color: #fff;
      border-radius: 6px;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      display: none;
      animation: slideIn 0.3s ease;
      z-index: 10000;
    }

    .notification.show {
      display: block;
    }

    .notification.success {
      background: #10b981;
    }

    .notification.error {
      background: #ef4444;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    /* åŠ è½½ä¸­çŠ¶æ€ */
    .loading {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      padding: 16px 24px;
      border-radius: 8px;
      font-size: 14px;
      z-index: 10001;
    }

    .loading.show {
      display: block;
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #fff;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* ç©ºçŠ¶æ€ */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #999;
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- é¡¶éƒ¨æ ‡é¢˜æ  -->
    <div class="header">
      <h1>æˆªå›¾é¢„è§ˆ</h1>
      <button class="close-btn" id="closeBtn">Ã—</button>
    </div>

    <!-- é¢„è§ˆåŒºåŸŸ -->
    <div class="preview" id="preview">
      <div class="empty-state">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
          <circle cx="8.5" cy="8.5" r="1.5"></circle>
          <polyline points="21 15 16 10 5 21"></polyline>
        </svg>
        <p>æš‚æ— æˆªå›¾</p>
      </div>
    </div>

    <!-- å·¥å…·æ  -->
    <div class="toolbar">
      <button class="toolbar-btn primary" id="copyBtn" disabled>
        ğŸ“‹ å¤åˆ¶åˆ°å‰ªè´´æ¿
      </button>
      <button class="toolbar-btn" id="saveBtn" disabled>
        ğŸ’¾ ä¿å­˜åˆ°æ–‡ä»¶
      </button>
      <button class="toolbar-btn" id="analyzeBtn" disabled>
        ğŸ” AI åˆ†æ
      </button>
      <button class="toolbar-btn" id="ocrBtn" disabled>
        ğŸ“ OCR è¯†åˆ«
      </button>
      <button class="toolbar-btn" id="translateBtn" disabled>
        ğŸŒ ç¿»è¯‘æ–‡å­—
      </button>
    </div>

    <!-- åˆ†æç»“æœ -->
    <div class="analysis-result" id="analysisResult">
      <h3 id="analysisTitle">åˆ†æç»“æœ</h3>
      <pre id="analysisContent"></pre>
    </div>
  </div>

  <!-- é€šçŸ¥æç¤º -->
  <div class="notification" id="notification"></div>

  <!-- åŠ è½½ä¸­ -->
  <div class="loading" id="loading">
    <span class="spinner"></span>
    <span id="loadingText">å¤„ç†ä¸­...</span>
  </div>

  <script>
    const { ipcRenderer } = require('electron');

    let currentScreenshot = null;
    let currentImageElement = null;

    // DOM å…ƒç´ 
    const preview = document.getElementById('preview');
    const copyBtn = document.getElementById('copyBtn');
    const saveBtn = document.getElementById('saveBtn');
    const analyzeBtn = document.getElementById('analyzeBtn');
    const ocrBtn = document.getElementById('ocrBtn');
    const translateBtn = document.getElementById('translateBtn');
    const closeBtn = document.getElementById('closeBtn');
    const analysisResult = document.getElementById('analysisResult');
    const analysisTitle = document.getElementById('analysisTitle');
    const analysisContent = document.getElementById('analysisContent');
    const notification = document.getElementById('notification');
    const loading = document.getElementById('loading');
    const loadingText = document.getElementById('loadingText');

    // æ˜¾ç¤ºé€šçŸ¥
    function showNotification(message, type = 'info') {
      notification.textContent = message;
      notification.className = 'notification show ' + type;
      setTimeout(() => {
        notification.classList.remove('show');
      }, 3000);
    }

    // æ˜¾ç¤ºåŠ è½½ä¸­
    function showLoading(text) {
      loadingText.textContent = text || 'å¤„ç†ä¸­...';
      loading.classList.add('show');
    }

    // éšè—åŠ è½½ä¸­
    function hideLoading() {
      loading.classList.remove('show');
    }

    // åŠ è½½æˆªå›¾
    function loadScreenshot(screenshotId, filePath) {
      currentScreenshot = { id: screenshotId, filePath };

      // åˆ›å»ºå›¾ç‰‡å…ƒç´ 
      const img = document.createElement('img');
      img.src = filePath;
      img.onload = () => {
        preview.innerHTML = '';
        preview.appendChild(img);
        currentImageElement = img;

        // å¯ç”¨æŒ‰é’®
        copyBtn.disabled = false;
        saveBtn.disabled = false;
        analyzeBtn.disabled = false;
        ocrBtn.disabled = false;
        translateBtn.disabled = false;
      };
      img.onerror = () => {
        showNotification('åŠ è½½æˆªå›¾å¤±è´¥', 'error');
      };
    }

    // å¤åˆ¶åˆ°å‰ªè´´æ¿
    async function copyToClipboard() {
      if (!currentScreenshot) return;

      try {
        const result = await ipcRenderer.invoke('screenshot:copy-to-clipboard', currentScreenshot.filePath);
        if (result.success) {
          showNotification('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
        } else {
          showNotification('å¤åˆ¶å¤±è´¥ï¼š' + result.error, 'error');
        }
      } catch (error) {
        showNotification('å¤åˆ¶å¤±è´¥ï¼š' + error.message, 'error');
      }
    }

    // ä¿å­˜åˆ°æ–‡ä»¶
    async function saveToFile() {
      if (!currentScreenshot) return;

      // æ–‡ä»¶å·²ç»ä¿å­˜ï¼Œè¿™é‡Œå¯ä»¥å®ç°å¦å­˜ä¸ºåŠŸèƒ½
      showNotification('æˆªå›¾å·²ä¿å­˜åˆ°ï¼š' + currentScreenshot.filePath, 'success');
    }

    // AI åˆ†æ
    async function analyzeWithAI() {
      if (!currentScreenshot) return;

      try {
        showLoading('AI åˆ†æä¸­...');
        const result = await ipcRenderer.invoke('screenshot:analyze', currentScreenshot.id, 'è¯·åˆ†æè¿™å¼ æˆªå›¾çš„å†…å®¹');
        hideLoading();

        if (result.success) {
          showAnalysisResult('AI åˆ†æç»“æœ', result.result);
        } else {
          showNotification('åˆ†æå¤±è´¥ï¼š' + result.error, 'error');
        }
      } catch (error) {
        hideLoading();
        showNotification('åˆ†æå¤±è´¥ï¼š' + error.message, 'error');
      }
    }

    // OCR è¯†åˆ«
    async function performOCR() {
      if (!currentScreenshot) return;

      try {
        showLoading('OCR è¯†åˆ«ä¸­...');
        const result = await ipcRenderer.invoke('screenshot:ocr', currentScreenshot.id, 'chi_sim+eng');
        hideLoading();

        if (result.success) {
          showAnalysisResult('OCR è¯†åˆ«ç»“æœ', result.result);
        } else {
          showNotification('OCR å¤±è´¥ï¼š' + result.error, 'error');
        }
      } catch (error) {
        hideLoading();
        showNotification('OCR å¤±è´¥ï¼š' + error.message, 'error');
      }
    }

    // ç¿»è¯‘æ–‡å­—
    async function translateText() {
      if (!currentScreenshot) return;

      try {
        showLoading('ç¿»è¯‘ä¸­...');
        const result = await ipcRenderer.invoke('screenshot:translate', currentScreenshot.id, 'zh');
        hideLoading();

        if (result.success) {
          showAnalysisResult('ç¿»è¯‘ç»“æœ', result.result);
        } else {
          showNotification('ç¿»è¯‘å¤±è´¥ï¼š' + result.error, 'error');
        }
      } catch (error) {
        hideLoading();
        showNotification('ç¿»è¯‘å¤±è´¥ï¼š' + error.message, 'error');
      }
    }

    // æ˜¾ç¤ºåˆ†æç»“æœ
    function showAnalysisResult(title, content) {
      analysisTitle.textContent = title;
      analysisContent.textContent = content;
      analysisResult.classList.add('show');
    }

    // å…³é—­çª—å£
    function closeWindow() {
      ipcRenderer.send('close-screenshot-window');
    }

    // äº‹ä»¶ç»‘å®š
    copyBtn.addEventListener('click', copyToClipboard);
    saveBtn.addEventListener('click', saveToFile);
    analyzeBtn.addEventListener('click', analyzeWithAI);
    ocrBtn.addEventListener('click', performOCR);
    translateBtn.addEventListener('click', translateText);
    closeBtn.addEventListener('click', closeWindow);

    // ç›‘å¬åŠ è½½æˆªå›¾äº‹ä»¶
    ipcRenderer.on('screenshot:load', (event, screenshotId, filePath) => {
      loadScreenshot(screenshotId, filePath);
    });

    // é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeWindow();
      } else if (e.ctrlKey || e.metaKey) {
        if (e.key === 'c') {
          e.preventDefault();
          copyToClipboard();
        } else if (e.key === 's') {
          e.preventDefault();
          saveToFile();
        }
      }
    });
  </script>
</body>
</html>
